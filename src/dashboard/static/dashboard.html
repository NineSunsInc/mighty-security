<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Mighty MCP Security Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --dark: #1f2937; --light: #f9fafb; --border: #e5e7eb;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1400px; margin: 0 auto; background: white;
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 30px;
        }
        .header h1 { font-size: 2.5rem; }
        .tabs {
            display: flex; background: var(--light); border-bottom: 2px solid var(--border);
        }
        .tab {
            padding: 15px 30px; cursor: pointer; background: none; border: none;
            font-size: 16px; color: var(--dark); transition: all 0.3s;
        }
        .tab:hover { background: white; }
        .tab.active {
            background: white; color: var(--primary); font-weight: 600;
            border-bottom: 3px solid var(--primary);
        }
        .content { padding: 30px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .scan-section {
            background: var(--light); padding: 20px; border-radius: 10px;
            margin: 20px 0;
        }
        .input-group { margin: 20px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .input-group input, .input-group select {
            width: 100%; padding: 10px; border: 2px solid var(--border);
            border-radius: 5px; font-size: 16px;
        }
        .btn {
            padding: 12px 30px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            background: var(--primary); color: white;
            margin: 10px 10px 10px 0;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary {
            background: var(--light); color: var(--dark);
            border: 2px solid var(--border);
        }
        .btn-small {
            padding: 6px 15px; font-size: 14px;
        }
        .results {
            margin-top: 30px; padding: 20px; background: #f8f9fa;
            border-radius: 10px; display: none;
        }
        .results.show { display: block; }
        .threat-card {
            background: white; padding: 15px; margin: 10px 0;
            border-left: 4px solid var(--danger); border-radius: 5px;
        }
        .loading { text-align: center; padding: 20px; display: none; }
        .loading.show { display: block; }
        .scan-modes {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px; margin: 20px 0;
        }
        .scan-mode {
            padding: 15px; border: 2px solid var(--border); border-radius: 8px;
            cursor: pointer; transition: all 0.3s;
        }
        .scan-mode:hover { border-color: var(--primary); }
        .scan-mode.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .report-table {
            width: 100%; border-collapse: collapse; margin-top: 20px;
        }
        .report-table th, .report-table td {
            padding: 12px; text-align: left; border-bottom: 1px solid var(--border);
        }
        .report-table th {
            background: var(--light); font-weight: 600;
        }
        .report-table tr:hover { background: var(--light); }
        .threat-badge {
            padding: 4px 8px; border-radius: 4px; font-size: 12px;
            font-weight: 600; display: inline-block;
        }
        .threat-critical { background: #fee2e2; color: #dc2626; }
        .threat-high { background: #fef3c7; color: #d97706; }
        .threat-medium { background: #dbeafe; color: #2563eb; }
        .threat-low { background: #d1fae5; color: #059669; }
        .report-detail {
            background: white; padding: 20px; border-radius: 10px;
            border: 1px solid var(--border); margin-top: 20px;
        }
        .detail-section {
            margin: 20px 0; padding: 15px; background: var(--light);
            border-radius: 8px;
        }
        .metric {
            display: flex; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid var(--border);
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 600; }
        .metric-value { color: #4b5563; }
        pre {
            background: #1f2937; color: #f9fafb; padding: 15px;
            border-radius: 8px; overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Mighty MCP Security Dashboard</h1>
            <p>Comprehensive security scanning for MCP tools</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('scanner')">üîç Scanner</button>
            <button class="tab" onclick="switchTab('reports')">üìä Reports</button>
            <button class="tab" onclick="switchTab('history')">üìú History</button>
        </div>
        
        <div class="content">
            <!-- Scanner Tab -->
            <div id="scanner" class="tab-panel active">
                <div class="scan-section">
                    <h2>Security Scanner</h2>
                    
                    <div class="scan-modes" id="scanModes">
                        <div class="scan-mode" data-mode="github" onclick="selectMode('github')">
                            <h3>üêô GitHub Repository</h3>
                            <p>Scan any GitHub repository for security threats</p>
                        </div>
                        <div class="scan-mode" data-mode="local" onclick="selectMode('local')">
                            <h3>üìÅ Local Directory</h3>
                            <p>Scan files or directories on your computer</p>
                        </div>
                        <div class="scan-mode" data-mode="quick" onclick="selectMode('quick')">
                            <h3>‚ö° Quick Scan</h3>
                            <p>Fast scan with basic threat detection</p>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="target">Target (GitHub URL or Local Path)</label>
                        <input type="text" id="target" placeholder="e.g., https://github.com/user/repo or /path/to/directory">
                    </div>
                    
                    <button class="btn" id="scanBtn" onclick="startScan()">üöÄ Start Security Scan</button>
                    <button class="btn btn-secondary" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
                    
                    <div class="loading" id="loading">
                        <p>‚è≥ Scanning... This may take a few moments...</p>
                    </div>
                    
                    <div class="results" id="results"></div>
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="reports" class="tab-panel">
                <h2>Scan Reports</h2>
                <p>View detailed reports from your security scans</p>
                
                <div id="reportsList">
                    <div class="loading" id="reportsLoading">
                        <p>Loading reports...</p>
                    </div>
                </div>
                
                <div id="reportDetail" style="display: none;"></div>
            </div>
            
            <!-- History Tab -->
            <div id="history" class="tab-panel">
                <h2>Scan History</h2>
                <button class="btn btn-secondary btn-small" onclick="loadHistory()">üîÑ Refresh</button>
                
                <table class="report-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Target</th>
                            <th>Type</th>
                            <th>Threat Level</th>
                            <th>Score</th>
                            <th>Threats</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="7">No scan history available</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let selectedMode = 'github';
        let currentReports = [];
        
        function switchTab(tabName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load data for the tab
            if (tabName === 'reports') {
                loadReports();
            } else if (tabName === 'history') {
                loadHistory();
            }
        }
        
        function selectMode(mode) {
            selectedMode = mode;
            document.querySelectorAll('.scan-mode').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
            
            // Update placeholder
            const input = document.getElementById('target');
            if (mode === 'github') {
                input.placeholder = 'e.g., https://github.com/modelcontextprotocol/servers';
            } else {
                input.placeholder = 'e.g., /Users/jh/Code/nine-suns/secure-toolings/examples';
            }
        }
        
        async function startScan() {
            const target = document.getElementById('target').value;
            if (!target) {
                alert('Please enter a target to scan');
                return;
            }
            
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const scanBtn = document.getElementById('scanBtn');
            
            loading.classList.add('show');
            results.classList.remove('show');
            scanBtn.disabled = true;
            
            try {
                let endpoint = '';
                let body = {};
                
                if (selectedMode === 'github' || target.includes('github.com')) {
                    endpoint = '/api/scan/github';
                    body = { repo_url: target, quick_mode: selectedMode === 'quick' };
                } else {
                    endpoint = '/api/scan/local';
                    body = { target_path: target, quick_mode: selectedMode === 'quick' };
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data);
                    // Store in session for reports
                    if (data.run_id) {
                        sessionStorage.setItem(`scan_${data.run_id}`, JSON.stringify(data));
                    }
                } else {
                    results.innerHTML = `<div style="color: red;">Error: ${data.detail || 'Scan failed'}</div>`;
                    results.classList.add('show');
                }
            } catch (error) {
                results.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
                results.classList.add('show');
            } finally {
                loading.classList.remove('show');
                scanBtn.disabled = false;
            }
        }
        
        function displayResults(data) {
            const results = document.getElementById('results');
            
            let html = '<h3>Scan Results</h3>';
            
            // Summary section
            html += '<div class="detail-section">';
            html += '<h4>Summary</h4>';
            html += `<div class="metric"><span class="metric-label">Run ID:</span><span class="metric-value">${data.run_id || 'N/A'}</span></div>`;
            html += `<div class="metric"><span class="metric-label">Target:</span><span class="metric-value">${data.repo || data.target || 'Unknown'}</span></div>`;
            html += `<div class="metric"><span class="metric-label">Threat Score:</span><span class="metric-value">${data.threat_score || '0%'}</span></div>`;
            html += `<div class="metric"><span class="metric-label">Threat Level:</span><span class="metric-value threat-badge threat-${(data.threat_level || 'low').toLowerCase()}">${data.threat_level || 'Unknown'}</span></div>`;
            html += `<div class="metric"><span class="metric-label">Total Files:</span><span class="metric-value">${data.total_files || 0}</span></div>`;
            html += `<div class="metric"><span class="metric-label">Total Lines:</span><span class="metric-value">${data.total_lines || 0}</span></div>`;
            html += '</div>';
            
            if (data.threats && data.threats.length > 0) {
                html += '<div class="detail-section">';
                html += `<h4>Threats Found (${data.threats.length})</h4>`;
                data.threats.forEach((threat, index) => {
                    html += `
                        <div class="threat-card">
                            <strong>#${index + 1}: ${threat.attack_vector}</strong> 
                            <span class="threat-badge threat-${(threat.severity || 'medium').toLowerCase()}">${threat.severity}</span><br>
                            ${threat.description}<br>
                            <small>File: ${threat.file_path || 'N/A'}</small>
                            ${threat.line_numbers ? `<br><small>Lines: ${threat.line_numbers.join(', ')}</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<p style="color: green; font-size: 18px; margin: 20px 0;">‚úÖ No threats detected!</p>';
            }
            
            // Add button to view full report
            if (data.run_id) {
                html += `<button class="btn btn-secondary" onclick="viewFullReport('${data.run_id}')">üìÑ View Full Report</button>`;
            }
            
            results.innerHTML = html;
            results.classList.add('show');
        }
        
        async function loadReports() {
            const container = document.getElementById('reportsList');
            container.innerHTML = '<p>Loading reports...</p>';
            
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.recent_scans && data.recent_scans.length > 0) {
                    let html = '<table class="report-table">';
                    html += '<thead><tr><th>Date</th><th>Target</th><th>Score</th><th>Level</th><th>Actions</th></tr></thead>';
                    html += '<tbody>';
                    
                    data.recent_scans.forEach(scan => {
                        const date = new Date(scan.timestamp).toLocaleString();
                        const level = scan.threat_level || 'Unknown';
                        html += `
                            <tr>
                                <td>${date}</td>
                                <td>${scan.repo_name || scan.repo_url}</td>
                                <td>${scan.threat_score}/100</td>
                                <td><span class="threat-badge threat-${level.toLowerCase()}">${level}</span></td>
                                <td><button class="btn btn-small" onclick="viewFullReport('${scan.run_id}')">View</button></td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                    currentReports = data.recent_scans;
                } else {
                    container.innerHTML = '<p>No reports available yet. Run a scan to generate reports.</p>';
                }
            } catch (error) {
                container.innerHTML = `<p style="color: red;">Failed to load reports: ${error.message}</p>`;
            }
        }
        
        async function loadHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
            
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.recent_scans && data.recent_scans.length > 0) {
                    let html = '';
                    data.recent_scans.forEach(scan => {
                        const date = new Date(scan.timestamp).toLocaleString();
                        const level = scan.threat_level || 'Unknown';
                        html += `
                            <tr>
                                <td>${date}</td>
                                <td>${scan.repo_name || scan.repo_url}</td>
                                <td>${scan.scan_type}</td>
                                <td><span class="threat-badge threat-${level.toLowerCase()}">${level}</span></td>
                                <td>${scan.threat_score}/100</td>
                                <td>${scan.total_threats}</td>
                                <td>
                                    <button class="btn btn-small" onclick="viewFullReport('${scan.run_id}')">View</button>
                                    <button class="btn btn-small btn-secondary" onclick="downloadReport('${scan.run_id}')">üì•</button>
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="7">No scan history available</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" style="color: red;">Failed to load history: ${error.message}</td></tr>`;
            }
        }
        
        async function viewFullReport(runId) {
            // Switch to reports tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('reports').classList.add('active');
            
            const detailContainer = document.getElementById('reportDetail');
            detailContainer.style.display = 'block';
            detailContainer.innerHTML = '<p>Loading report...</p>';
            
            try {
                // Try session storage first
                let data = sessionStorage.getItem(`scan_${runId}`);
                if (data) {
                    data = JSON.parse(data);
                } else {
                    // Fetch from API
                    const response = await fetch(`/api/run/${runId}`);
                    data = await response.json();
                }
                
                let html = '<div class="report-detail">';
                html += `<h3>Full Security Report</h3>`;
                html += `<button class="btn btn-small btn-secondary" onclick="document.getElementById('reportDetail').style.display='none'">‚Üê Back</button>`;
                
                // Metadata
                html += '<div class="detail-section">';
                html += '<h4>Scan Information</h4>';
                html += `<div class="metric"><span class="metric-label">Run ID:</span><span class="metric-value">${data.run_id || runId}</span></div>`;
                html += `<div class="metric"><span class="metric-label">Target:</span><span class="metric-value">${data.repo_url || data.target || 'Unknown'}</span></div>`;
                html += `<div class="metric"><span class="metric-label">Scan Type:</span><span class="metric-value">${data.scan_type || 'static'}</span></div>`;
                html += `<div class="metric"><span class="metric-label">Timestamp:</span><span class="metric-value">${new Date(data.scan_timestamp || Date.now()).toLocaleString()}</span></div>`;
                html += '</div>';
                
                // Threat Summary
                html += '<div class="detail-section">';
                html += '<h4>Threat Analysis</h4>';
                html += `<div class="metric"><span class="metric-label">Overall Score:</span><span class="metric-value">${data.threat_score || 0}/100</span></div>`;
                html += `<div class="metric"><span class="metric-label">Threat Level:</span><span class="metric-value threat-badge threat-${(data.threat_level || 'low').toLowerCase()}">${data.threat_level || 'Unknown'}</span></div>`;
                html += `<div class="metric"><span class="metric-label">Total Threats:</span><span class="metric-value">${data.total_threats || 0}</span></div>`;
                html += `<div class="metric"><span class="metric-label">Files Analyzed:</span><span class="metric-value">${data.total_files || 0}</span></div>`;
                html += `<div class="metric"><span class="metric-label">Lines Analyzed:</span><span class="metric-value">${data.total_lines || 0}</span></div>`;
                html += '</div>';
                
                // Detailed Threats
                if (data.threats && data.threats.length > 0) {
                    html += '<div class="detail-section">';
                    html += '<h4>Detailed Threat Information</h4>';
                    
                    data.threats.forEach((threat, index) => {
                        html += `
                            <div class="threat-card">
                                <h5>Threat #${index + 1}: ${threat.attack_vector}</h5>
                                <p><strong>Severity:</strong> <span class="threat-badge threat-${(threat.severity || 'medium').toLowerCase()}">${threat.severity}</span></p>
                                <p><strong>Description:</strong> ${threat.description}</p>
                                <p><strong>File:</strong> <code>${threat.file_path || 'N/A'}</code></p>
                                ${threat.line_numbers ? `<p><strong>Lines:</strong> ${threat.line_numbers.join(', ')}</p>` : ''}
                                ${threat.confidence ? `<p><strong>Confidence:</strong> ${threat.confidence}</p>` : ''}
                                ${threat.evidence && threat.evidence.length ? `
                                    <details>
                                        <summary style="cursor: pointer;">View Evidence</summary>
                                        <pre>${threat.evidence.join('\n')}</pre>
                                    </details>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += '<div class="detail-section">';
                    html += '<p style="color: green; font-size: 18px;">‚úÖ No security threats detected in this scan.</p>';
                    html += '</div>';
                }
                
                // Fingerprints if available
                if (data.fingerprints) {
                    html += '<div class="detail-section">';
                    html += '<h4>Security Fingerprints</h4>';
                    html += `<div class="metric"><span class="metric-label">SHA-512:</span><span class="metric-value" style="font-family: monospace; font-size: 12px;">${data.fingerprints.sha512 || 'N/A'}</span></div>`;
                    html += `<div class="metric"><span class="metric-label">SHA3-512:</span><span class="metric-value" style="font-family: monospace; font-size: 12px;">${data.fingerprints.sha3_512 || 'N/A'}</span></div>`;
                    html += `<div class="metric"><span class="metric-label">Merkle Root:</span><span class="metric-value" style="font-family: monospace; font-size: 12px;">${data.fingerprints.merkle_root || 'N/A'}</span></div>`;
                    html += '</div>';
                }
                
                html += `<button class="btn btn-secondary" onclick="downloadReport('${runId}')">üì• Download JSON Report</button>`;
                html += '</div>';
                
                detailContainer.innerHTML = html;
                document.getElementById('reportsList').style.display = 'none';
            } catch (error) {
                detailContainer.innerHTML = `<p style="color: red;">Failed to load report: ${error.message}</p>`;
            }
        }
        
        async function downloadReport(runId) {
            try {
                const response = await fetch(`/api/run/${runId}`);
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `security-report-${runId}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Failed to download report: ' + error.message);
            }
        }
        
        async function clearCache() {
            if (confirm('Clear all cached scan results? This will not delete the database records.')) {
                sessionStorage.clear();
                alert('Cache cleared!');
            }
        }
        
        // Initialize with GitHub mode selected
        selectMode('github');
    </script>
</body>
</html>